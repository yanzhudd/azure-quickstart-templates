arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"adminUsername": {"type": "string", "metadata": {"description": "Username for the Virtual Machine."}, "defaultValue": "zytest"}, "adminPassword": {"type": "securestring", "metadata": {"description": "Password for the Virtual Machine."}, "defaultValue": "zytest"}, "_artifactsLocation": {"type": "string", "metadata": {"description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."}, "defaultValue": "[deployment().properties.templateLink.uri]"}, "_artifactsLocationSasToken": {"type": "securestring", "metadata": {"description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."}, "defaultValue": ""}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location for all resources."}}, "vmSize": {"type": "string", "defaultValue": "Standard_D2_v3", "metadata": {"description": "Default VM Size"}}, "dnsNameForPublicIP": {"type": "string", "metadata": {"description": "DNS name for the public IP"}, "defaultValue": "zytest"}}, "variables": {"nicName": "myVMNic", "addressPrefix": "10.0.0.0/16", "subnetName": "Subnet", "subnetPrefix": "10.0.0.0/24", "subnetRef": "[resourceId(\'Microsoft.Network/virtualNetworks/subnets\', variables(\'virtualNetworkName\'), variables(\'subnetName\'))]", "vmName": "MyVM", "virtualNetworkName": "MyVNET", "publicIPAddressName": "myPublicIP", "scriptFolder": "scripts", "scriptFileName": "Copy-FileFromAzure.ps1", "fileToBeCopied": "FileToBeCopied.txt", "scriptParameters": "[concat(\'-artifactsLocation \', replace(parameters(\'_artifactsLocation\'),parameters(\'_artifactsLocationSasToken\'),\'\'), \' -artifactsLocationSasToken \\"\', parameters(\'_artifactsLocationSasToken\'), \'\\" -folderName \', variables(\'scriptFolder\'), \' -fileToInstall \', variables(\'fileToBeCopied\'))]", "networkSecurityGroupName": "default-NSG"}, "resources": [{"apiVersion": "2020-08-01", "type": "Microsoft.Network/publicIPAddresses", "name": "[variables(\'publicIPAddressName\')]", "location": "[parameters(\'location\')]", "properties": {"publicIPAllocationMethod": "Dynamic", "dnsSettings": {"domainNameLabel": "[parameters(\'dnsNameForPublicIP\')]"}}}, {"comments": "Default Network Security Group for template", "type": "Microsoft.Network/networkSecurityGroups", "apiVersion": "2020-08-01", "name": "[variables(\'networkSecurityGroupName\')]", "location": "[parameters(\'location\')]", "properties": {"securityRules": [{"name": "default-allow-3389", "properties": {"priority": 1000, "access": "Allow", "direction": "Inbound", "destinationPortRange": "3389", "protocol": "Tcp", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*"}}]}}, {"apiVersion": "2020-08-01", "type": "Microsoft.Network/virtualNetworks", "name": "[variables(\'virtualNetworkName\')]", "location": "[parameters(\'location\')]", "dependsOn": ["[resourceId(\'Microsoft.Network/networkSecurityGroups\', variables(\'networkSecurityGroupName\'))]"], "properties": {"addressSpace": {"addressPrefixes": ["[variables(\'addressPrefix\')]"]}, "subnets": [{"name": "[variables(\'subnetName\')]", "properties": {"addressPrefix": "[variables(\'subnetPrefix\')]", "networkSecurityGroup": {"id": "[resourceId(\'Microsoft.Network/networkSecurityGroups\', variables(\'networkSecurityGroupName\'))]"}}}]}}, {"apiVersion": "2020-08-01", "type": "Microsoft.Network/networkInterfaces", "name": "[variables(\'nicName\')]", "location": "[parameters(\'location\')]", "dependsOn": ["[variables(\'publicIPAddressName\')]", "[variables(\'virtualNetworkName\')]"], "properties": {"ipConfigurations": [{"name": "ipconfig1", "properties": {"privateIPAllocationMethod": "Dynamic", "publicIPAddress": {"id": "[resourceId(\'Microsoft.Network/publicIPAddresses\',variables(\'publicIPAddressName\'))]"}, "subnet": {"id": "[variables(\'subnetRef\')]"}}}]}}, {"apiVersion": "2020-12-01", "type": "Microsoft.Compute/virtualMachines", "name": "[variables(\'vmName\')]", "location": "[parameters(\'location\')]", "dependsOn": ["[variables(\'nicName\')]"], "properties": {"hardwareProfile": {"vmSize": "[parameters(\'vmSize\')]"}, "osProfile": {"computerName": "[variables(\'vmName\')]", "adminUsername": "[parameters(\'adminUsername\')]", "adminPassword": "[parameters(\'adminPassword\')]"}, "storageProfile": {"imageReference": {"publisher": "MicrosoftWindowsServer", "offer": "WindowsServer", "sku": "2016-Datacenter", "version": "latest"}, "osDisk": {"createOption": "FromImage"}}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId(\'Microsoft.Network/networkInterfaces\',variables(\'nicName\'))]"}]}}, "resources": [{"type": "extensions", "name": "CustomScriptExtension", "apiVersion": "2020-12-01", "location": "[parameters(\'location\')]", "dependsOn": ["[variables(\'vmName\')]"], "properties": {"publisher": "Microsoft.Compute", "type": "CustomScriptExtension", "typeHandlerVersion": "1.8", "autoUpgradeMinorVersion": true, "settings": {"fileUris": ["[uri(parameters(\'_artifactsLocation\'), concat(variables(\'scriptFolder\'),\'/\',variables(\'scriptFileName\'), parameters(\'_artifactsLocationSasToken\')))]"], "commandToExecute": "[concat(\'powershell -ExecutionPolicy Unrestricted -File \', variables(\'scriptFolder\'), \'/\', variables(\'scriptFileName\'), \' \', variables(\'scriptParameters\'))]"}}}]}], "outputs": {"vm-fqdn": {"type": "string", "value": "[reference(variables(\'publicIPAddressName\'), \'2020-07-01\').dnsSettings.fqdn]"}}}


cli_script
'content': '#!/bin/bash\n\n# Define variables\nadminUsername="zytest"\nadminPassword="zytest"\n_artifactsLocation="[deployment().properties.templateLink.uri]"\n_artifactsLocationSasToken=""\nlocation="westus"\nvmSize="Standard_D2_v3"\ndnsNameForPublicIP="zytest"\nnicName="myVMNic"\naddressPrefix="10.0.0.0/16"\nsubnetName="Subnet"\nsubnetPrefix="10.0.0.0/24"\nvmName="MyVM"\nvirtualNetworkName="MyVNET"\npublicIPAddressName="myPublicIP"\nscriptFolder="scripts"\nscriptFileName="Copy-FileFromAzure.ps1"\nfileToBeCopied="FileToBeCopied.txt"\nnetworkSecurityGroupName="default-NSG"\n\n# Create public IP address\naz network public-ip create --name $publicIPAddressName --resource-group $resourceGroupName --location $location --dns-name $dnsNameForPublicIP --allocation-method Dynamic\n\n# Create network security group\naz network nsg create --name $networkSecurityGroupName --resource-group $resourceGroupName --location $location\n\n# Create virtual network\naz network vnet create --name $virtualNetworkName --resource-group $resourceGroupName --location $location --address-prefix $addressPrefix --subnet-name $subnetName --subnet-prefix $subnetPrefix --network-security-group $networkSecurityGroupName\n\n# Create network interface\naz network nic create --name $nicName --resource-group $resourceGroupName --location $location --subnet $subnetName --public-ip-address $publicIPAddressName --vnet-name $virtualNetworkName\n\n# Create virtual machine\naz vm create --name $vmName --resource-group $resourceGroupName --location $location --nics $nicName --admin-username $adminUsername --admin-password $adminPassword --image MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest --size $vmSize\n\n# Add extension to virtual machine\naz vm extension set --publisher Microsoft.Compute --version 1.8 --name CustomScriptExtension --vm-name $vmName --resource-group $resourceGroupName --settings \'{"fileUris": ["\'$_artifactsLocation\'/\'$scriptFolder\'/\'$scriptFileName\'"], "commandToExecute": "powershell -ExecutionPolicy Unrestricted -File \'$scriptFolder\'/\'$scriptFileName\'"}\'', 'validation_results': [], 'command_count': 6, 'gpt_model': 'GPT_4_32k'


verify_result
