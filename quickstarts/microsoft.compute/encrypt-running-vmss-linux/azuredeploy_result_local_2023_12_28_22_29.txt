arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"vmssName": {"type": "string", "metadata": {"description": "Name of VMSS to be encrypted."}, "maxLength": 61, "defaultValue": "zytest"}, "keyVaultName": {"type": "string", "metadata": {"description": "Name of the KeyVault to place the volume encryption key."}, "defaultValue": "zytest"}, "keyVaultResourceGroup": {"type": "string", "metadata": {"description": "Resource group of the KeyVault"}, "defaultValue": "zytest"}, "keyEncryptionKeyURL": {"type": "string", "defaultValue": "", "metadata": {"description": "URL of the KeyEncryptionKey used to encrypt the volume encryption key"}}, "keyEncryptionAlgorithm": {"type": "string", "defaultValue": "RSA-OAEP", "metadata": {"description": "keyEncryptionAlgorithm used to wrap volume encryption key using KeyEncryptionKeyURL"}}, "volumeType": {"type": "string", "defaultValue": "Data", "metadata": {"description": "Volume type being targeted for encryption operation (Data is the only supported type in Linux VMSS Preview)"}}, "forceUpdateTag": {"type": "string", "defaultValue": "1.0", "metadata": {"description": "Pass in a unique value like a GUID everytime the operation needs to be force run"}}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Default location"}}}, "variables": {"extensionName": "AzureDiskEncryptionForLinux", "extensionVersion": "1.1", "encryptionOperation": "EnableEncryption", "keyVaultURL": "[concat(\'https://\', parameters(\'keyVaultName\'), environment().suffixes.keyvaultDns)]", "keyVaultResourceID": "[resourceId(parameters(\'keyVaultResourceGroup\'),\'Microsoft.KeyVault/vaults/\', parameters(\'keyVaultName\'))]"}, "resources": [{"type": "Microsoft.Compute/virtualMachineScaleSets", "name": "[parameters(\'vmssName\')]", "location": "[parameters(\'location\')]", "apiVersion": "2021-04-01", "sku": {"name": "Standard_D2_v3", "tier": "Standard", "capacity": 2}, "properties": {"virtualMachineProfile": {"extensionProfile": {"extensions": [{"name": "[variables(\'extensionName\')]", "properties": {"publisher": "Microsoft.Azure.Security", "type": "[variables(\'extensionName\')]", "typeHandlerVersion": "[variables(\'extensionVersion\')]", "autoUpgradeMinorVersion": true, "forceUpdateTag": "[parameters(\'forceUpdateTag\')]", "settings": {"EncryptionOperation": "[variables(\'encryptionOperation\')]", "KeyVaultURL": "[variables(\'keyVaultURL\')]", "KeyVaultResourceId": "[variables(\'keyVaultResourceID\')]", "KeyEncryptionKeyURL": "[parameters(\'keyEncryptionKeyURL\')]", "KekVaultResourceId": "[if(empty(parameters(\'keyEncryptionKeyURL\')),\'\',variables(\'keyVaultResourceID\'))]", "KeyEncryptionAlgorithm": "[parameters(\'keyEncryptionAlgorithm\')]", "VolumeType": "[parameters(\'volumeType\')]"}}}]}}}}]}


cli_script
Below is the Bash script that translates the provided ARM template and parameters into Azure CLI commands:\n\n```bash\n#!/bin/bash\n\n# Assigning parameter values to variables\nvmssName="zytest"\nkeyVaultName="zytest"\nkeyVaultResourceGroup="zytest"\nkeyEncryptionKeyURL=""\nkeyEncryptionAlgorithm="RSA-OAEP"\nvolumeType="Data"\nforceUpdateTag="1.0"\nlocation="westus"\n\n# Variables from ARM template (not directly translatable to CLI)\nextensionName="AzureDiskEncryptionForLinux"\nextensionVersion="1.1"\nencryptionOperation="EnableEncryption"\n# The keyVaultURL and keyVaultResourceID are ARM expressions and need to be constructed in the script.\n# For this example, we\'re assuming the environment\'s KeyVault DNS suffix is \'.vault.azure.net\'.\nkeyVaultURL="https://${keyVaultName}.vault.azure.net"\n# The resourceId function is not available in bash, so we construct the KeyVault resource ID manually.\nkeyVaultResourceID="/subscriptions/{subscriptionId}/resourceGroups/${keyVaultResourceGroup}/providers/Microsoft.KeyVault/vaults/${keyVaultName}"\n\n# Create or update Virtual Machine Scale Set with the Azure Disk Encryption extension\naz vmss create \\\n    --name $vmssName \\\n    --resource-group $keyVaultResourceGroup \\\n    --location $location \\\n    --vm-sku Standard_D2_v3 \\\n    --instance-count 2 \\\n    --upgrade-policy-mode Automatic\n\n# Adding the Azure Disk Encryption extension to the VMSS\naz vmss extension set \\\n    --vmss-name $vmssName \\\n    --resource-group $keyVaultResourceGroup \\\n    --name $extensionName \\\n    --publisher Microsoft.Azure.Security \\\n    --version $extensionVersion \\\n    --settings "{\\"EncryptionOperation\\":\\"$encryptionOperation\\", \\"KeyVaultURL\\":\\"$keyVaultURL\\", \\"KeyVaultResourceId\\":\\"$keyVaultResourceID\\", \\"KeyEncryptionKeyURL\\":\\"$keyEncryptionKeyURL\\", \\"KekVaultResourceId\\":\\"$keyVaultResourceID\\", \\"KeyEncryptionAlgorithm\\":\\"$keyEncryptionAlgorithm\\", \\"VolumeType\\":\\"$volumeType\\"}" \\\n    --protected-settings "{\\"forceUpdateTag\\":\\"$forceUpdateTag\\"}"\n\n# Note: If keyEncryptionKeyURL is empty, KekVaultResourceId should not be set.\n# The above command assumes it is always set for simplicity. \n# You may need to conditionally construct the settings to exclude "KekVaultResourceId" if keyEncryptionKeyURL is empty.\n```\n\nPlease replace `{subscriptionId}` with your actual subscription ID where the KeyVault resides.\n\nThis script assumes that the VMSS and KeyVault are in the same resource group. If that\'s not the case, you will need to modify the `--resource-group` parameter accordingly for each command. Additionally, the script assumes that the KeyVault DNS suffix is \'.vault.azure.net\', which is the default for public Azure regions. If you are using Azure in a different cloud (e.g., Azure Government), you will need to use the appropriate DNS suffix for that cloud.\n\nRemember to give execute permission to the script file before running it with the command `chmod +x script.sh`.


verify_result
{"diff_info": ["  ", "  Thedeploymentwillupdatethefollowingscope:", "  ", "  Scope:/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg", "  ", "  -Microsoft.CognitiveServices/accounts/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.CognitiveServices/accounts/cli-translator\\"", "  identity.type:\\"None\\"", "  kind:\\"FormRecognizer\\"", "  location:\\"westus2\\"", "  name:\\"cli-translator\\"", "  sku.name:\\"F0\\"", "  type:\\"Microsoft.CognitiveServices/accounts\\"", "  ", "  -Microsoft.DocumentDb/databaseAccounts/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.DocumentDb/databaseAccounts/cli-translator\\"", "  identity.type:\\"None\\"", "  kind:\\"GlobalDocumentDB\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  tags.defaultExperience:\\"Core(SQL)\\"", "  type:\\"Microsoft.DocumentDb/databaseAccounts\\"", "  ", "  -Microsoft.Search/searchServices/customdatasearch", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Search/searchServices/customdatasearch\\"", "  location:\\"westus2\\"", "  name:\\"customdatasearch\\"", "  sku.name:\\"standard\\"", "  tags.ProjectType:\\"aoai-your-data-service\\"", "  type:\\"Microsoft.Search/searchServices\\"", "  ", "  -Microsoft.Storage/storageAccounts/clitranslatorapi", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/clitranslatorapi\\"", "  kind:\\"Storage\\"", "  location:\\"westus\\"", "  name:\\"clitranslatorapi\\"", "  sku.name:\\"Standard_LRS\\"", "  sku.tier:\\"Standard\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Storage/storageAccounts/customdataforgpt", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/customdataforgpt\\"", "  kind:\\"StorageV2\\"", "  location:\\"eastus\\"", "  name:\\"customdataforgpt\\"", "  sku.name:\\"Standard_RAGRS\\"", "  sku.tier:\\"Standard\\"", "  tags.ProjectType:\\"aoai-your-data-service\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Storage/storageAccounts/translatortempfiles", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/translatortempfiles\\"", "  kind:\\"StorageV2\\"", "  location:\\"eastasia\\"", "  name:\\"translatortempfiles\\"", "  sku.name:\\"Standard_LRS\\"", "  sku.tier:\\"Standard\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Web/serverFarms/ASP-clitranslatorrg-bdc9", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Web/serverFarms/ASP-clitranslatorrg-bdc9\\"", "  kind:\\"functionapp\\"", "  location:\\"westus\\"", "  name:\\"ASP-clitranslatorrg-bdc9\\"", "  sku.capacity:0", "  sku.family:\\"Y\\"", "  sku.name:\\"Y1\\"", "  sku.size:\\"Y1\\"", "  sku.tier:\\"Dynamic\\"", "  type:\\"Microsoft.Web/serverFarms\\"", "  ", "  -Microsoft.Web/sites/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Web/sites/cli-translator\\"", "  kind:\\"functionapp,linux\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  tags.hidden-link:/app-insights-conn-string:\\"InstrumentationKey=11b638ce-0c16-42cc-9516-58122a1922ef;IngestionEndpoint=https://westus-0.in.applicationinsights.azure.com/;LiveEndpoint=https://westus.livediagnostics.monitor.azure.com/\\"", "  tags.hidden-link:/app-insights-instrumentation-key:\\"11b638ce-0c16-42cc-9516-58122a1922ef\\"", "  tags.hidden-link:/app-insights-resource-id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.insights/components/cli-translator\\"", "  type:\\"Microsoft.Web/sites\\"", "  ", "  -microsoft.alertsmanagement/smartDetectorAlertRules/FailureAnomalies-cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.alertsmanagement/smartDetectorAlertRules/FailureAnomalies-cli-translator\\"", "  location:\\"global\\"", "  name:\\"FailureAnomalies-cli-translator\\"", "  type:\\"microsoft.alertsmanagement/smartDetectorAlertRules\\"", "  ", "  -microsoft.insights/components/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.insights/components/cli-translator\\"", "  kind:\\"web\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  type:\\"microsoft.insights/components\\"", "  ", "  +Microsoft.Compute/virtualMachineScaleSets/zytest[]", "  ", "  apiVersion:\\"\\"", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Compute/virtualMachineScaleSets/zytest\\"", "  location:\\"westus\\"", "  name:\\"zytest\\"", "+ properties.sku.capacity:2", "+ properties.sku.name:\\"Standard_D2_v3\\"", "+ properties.sku.tier:\\"Standard\\"", "+ properties.upgradePolicy.mode:\\"Automatic\\"", "  properties.virtualMachineProfile.extensionProfile.extensions:[", "  0:", "  ", "  name:\\"AzureDiskEncryptionForLinux\\"", "  properties.autoUpgradeMinorVersion:true", "- properties.forceUpdateTag:\\"1.0\\"", "+ properties.protectedSettings:\\"*******\\"", "  properties.publisher:\\"Microsoft.Azure.Security\\"", "  properties.settings.EncryptionOperation:\\"EnableEncryption\\"", "+ properties.settings.KekVaultResourceId:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/zytest/providers/Microsoft.KeyVault/vaults/zytest\\"", "  properties.settings.KeyEncryptionAlgorithm:\\"RSA-OAEP\\"", "  properties.settings.KeyVaultResourceId:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/zytest/providers/Microsoft.KeyVault/vaults/zytest\\"", "  properties.settings.KeyVaultURL:\\"https://zytest.vault.azure.net\\"", "  properties.settings.VolumeType:\\"Data\\"", "  properties.type:\\"AzureDiskEncryptionForLinux\\"", "  properties.typeHandlerVersion:\\"1.1\\"", "  ", "  ]", "- sku.capacity:2", "- sku.name:\\"Standard_D2_v3\\"", "- sku.tier:\\"Standard\\"", "  tags.platformsettings.host_environment.service.platform_optedin_for_rootcerts:\\"true\\"", "  type:\\"Microsoft.Compute/virtualMachineScaleSets\\"", "  ", "  Resourcechanges:10todelete,1tocreate."], "diff_summary": {"added": 6, "deleted": 4, "differential_rate": "0.075"}}