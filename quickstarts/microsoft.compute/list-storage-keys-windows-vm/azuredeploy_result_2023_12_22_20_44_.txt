arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"adminUsername": {"type": "string", "metadata": {"description": "Username for the Virtual Machine."}, "defaultValue": "zytest"}, "adminPassword": {"type": "securestring", "metadata": {"description": "Password for the Virtual Machine."}, "defaultValue": "zytest"}, "customScriptStorageAccountName": {"type": "string", "metadata": {"description": "Name of the storage account."}, "defaultValue": "zytest"}, "_artifactsLocation": {"type": "string", "metadata": {"description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."}, "defaultValue": "[deployment().properties.templateLink.uri]"}, "_artifactsLocationSasToken": {"type": "securestring", "metadata": {"description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."}, "defaultValue": ""}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location for all resources."}}, "vmSize": {"type": "string", "defaultValue": "Standard_D2_v3", "metadata": {"description": "Default VM Size"}}}, "variables": {"nicName": "myVMNic", "addressPrefix": "10.0.0.0/16", "subnetName": "Subnet", "subnetPrefix": "10.0.0.0/24", "subnetRef": "[resourceId(\'Microsoft.Network/virtualNetworks/subnets\', variables(\'virtualNetworkName\'), variables(\'subnetName\'))]", "vmName": "MyVM", "virtualNetworkName": "MyVNET", "publicIPAddressName": "myPublicIP", "fileToBeCopied": "FileToBeCopied.txt", "scriptFolder": "scripts", "scriptFileName": "Copy-FileFromAzure.ps1", "accountid": "[resourceId(\'Microsoft.Storage/storageAccounts/\', parameters(\'customScriptStorageAccountName\'))]", "scriptParameters": "[concat(\'-artifactsLocation \', replace(parameters(\'_artifactsLocation\'),parameters(\'_artifactsLocationSasToken\'),\'\'), \' -artifactsLocationSasToken \\"\', parameters(\'_artifactsLocationSasToken\'), \'\\" -folderName \', variables(\'scriptFolder\'), \' -fileToInstall \', variables(\'fileToBeCopied\'))]", "networkSecurityGroupName": "default-NSG"}, "resources": [{"apiVersion": "2020-08-01", "type": "Microsoft.Network/publicIPAddresses", "name": "[variables(\'publicIPAddressName\')]", "location": "[parameters(\'location\')]", "properties": {"publicIPAllocationMethod": "Dynamic"}}, {"comments": "Default Network Security Group for template", "type": "Microsoft.Network/networkSecurityGroups", "apiVersion": "2020-08-01", "name": "[variables(\'networkSecurityGroupName\')]", "location": "[parameters(\'location\')]", "properties": {"securityRules": [{"name": "default-allow-3389", "properties": {"priority": 1000, "access": "Allow", "direction": "Inbound", "destinationPortRange": "3389", "protocol": "Tcp", "sourceAddressPrefix": "*", "sourcePortRange": "*", "destinationAddressPrefix": "*"}}]}}, {"apiVersion": "2020-08-01", "type": "Microsoft.Network/virtualNetworks", "name": "[variables(\'virtualNetworkName\')]", "location": "[parameters(\'location\')]", "dependsOn": ["[resourceId(\'Microsoft.Network/networkSecurityGroups\', variables(\'networkSecurityGroupName\'))]"], "properties": {"addressSpace": {"addressPrefixes": ["[variables(\'addressPrefix\')]"]}, "subnets": [{"name": "[variables(\'subnetName\')]", "properties": {"addressPrefix": "[variables(\'subnetPrefix\')]", "networkSecurityGroup": {"id": "[resourceId(\'Microsoft.Network/networkSecurityGroups\', variables(\'networkSecurityGroupName\'))]"}}}]}}, {"apiVersion": "2020-08-01", "type": "Microsoft.Network/networkInterfaces", "name": "[variables(\'nicName\')]", "location": "[parameters(\'location\')]", "dependsOn": ["[variables(\'publicIPAddressName\')]", "[variables(\'virtualNetworkName\')]"], "properties": {"ipConfigurations": [{"name": "ipconfig1", "properties": {"privateIPAllocationMethod": "Dynamic", "publicIPAddress": {"id": "[resourceId(\'Microsoft.Network/publicIPAddresses\',variables(\'publicIPAddressName\'))]"}, "subnet": {"id": "[variables(\'subnetRef\')]"}}}]}}, {"apiVersion": "2020-12-01", "type": "Microsoft.Compute/virtualMachines", "name": "[variables(\'vmName\')]", "location": "[parameters(\'location\')]", "dependsOn": ["[variables(\'nicName\')]"], "properties": {"hardwareProfile": {"vmSize": "[parameters(\'vmSize\')]"}, "osProfile": {"computerName": "[variables(\'vmName\')]", "adminUsername": "[parameters(\'adminUsername\')]", "adminPassword": "[parameters(\'adminPassword\')]"}, "storageProfile": {"imageReference": {"publisher": "MicrosoftWindowsServer", "offer": "WindowsServer", "sku": "2016-Datacenter", "version": "latest"}, "osDisk": {"createOption": "FromImage"}}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId(\'Microsoft.Network/networkInterfaces\',variables(\'nicName\'))]"}]}}, "resources": [{"type": "extensions", "name": "CustomScriptExtension", "apiVersion": "2020-12-01", "location": "[parameters(\'location\')]", "dependsOn": ["[variables(\'vmName\')]"], "properties": {"publisher": "Microsoft.Compute", "type": "CustomScriptExtension", "typeHandlerVersion": "1.8", "autoUpgradeMinorVersion": true, "settings": {"fileUris": ["[uri(parameters(\'_artifactsLocation\'), concat(variables(\'scriptFolder\'),\'/\',variables(\'scriptFileName\'), parameters(\'_artifactsLocationSasToken\')))]"], "commandToExecute": "[concat(\'powershell -ExecutionPolicy Unrestricted -File \', variables(\'scriptFolder\'), \'/\', variables(\'scriptFileName\'), \' \', variables(\'scriptParameters\'))]"}, "protectedSettings": {"storageAccountName": "[parameters(\'customScriptStorageAccountName\')]", "storageAccountKey": "[listKeys(variables(\'accountid\'),\'2021-01-01\').keys[0].value]"}}}]}]}


cli_script
Here is the equivalent CLI script:\n\n```bash\n#!/bin/bash\n\n# Define parameters\nadminUsername="zytest"\nadminPassword="zytest"\ncustomScriptStorageAccountName="zytest"\n_artifactsLocation="[deployment().properties.templateLink.uri]"\n_artifactsLocationSasToken=""\nlocation="westus"\nvmSize="Standard_D2_v3"\n\n# Create public IP address\naz network public-ip create --name myPublicIP --allocation-method Dynamic --location $location\n\n# Create network security group\naz network nsg create --name default-NSG --location $location\n\n# Add security rule to the network security group\naz network nsg rule create --name default-allow-3389 --nsg-name default-NSG --priority 1000 --access Allow --direction Inbound --destination-port-ranges 3389 --protocol Tcp --source-address-prefixes \'*\' --source-port-ranges \'*\' --destination-address-prefixes \'*\'\n\n# Create virtual network\naz network vnet create --name MyVNET --address-prefix 10.0.0.0/16 --location $location\n\n# Create subnet\naz network vnet subnet create --name Subnet --vnet-name MyVNET --address-prefix 10.0.0.0/24 --network-security-group default-NSG\n\n# Create network interface\naz network nic create --name myVMNic --vnet-name MyVNET --subnet Subnet --public-ip-address myPublicIP --location $location\n\n# Create virtual machine\naz vm create --name MyVM --location $location --nics myVMNic --admin-username $adminUsername --admin-password $adminPassword --image MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest --size $vmSize\n\n# Add extension to the virtual machine\naz vm extension set --name CustomScriptExtension --publisher Microsoft.Compute --version 1.8 --vm-name MyVM --settings \'{"fileUris": ["\'$_artifactsLocation\'/scripts/Copy-FileFromAzure.ps1\'$_artifactsLocationSasToken\'"], "commandToExecute": "powershell -ExecutionPolicy Unrestricted -File scripts/Copy-FileFromAzure.ps1 -artifactsLocation \'$_artifactsLocation\' -artifactsLocationSasToken \'$_artifactsLocationSasToken\' -folderName scripts -fileToInstall FileToBeCopied.txt"}\' --protected-settings \'{"storageAccountName": "\'$customScriptStorageAccountName\'", "storageAccountKey": "$(az storage account keys list --account-name \'$customScriptStorageAccountName\' --query [0].value --output tsv)"}\'\n```\n\nPlease replace the placeholder values with your actual values before running the script.


verify_result
