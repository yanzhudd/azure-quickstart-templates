arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "metadata": {"_generator": {"name": "bicep", "version": "0.5.6.12127", "templateHash": "16594126968631223272"}}, "parameters": {"vmSize": {"type": "string", "defaultValue": "Standard_A2_v2", "metadata": {"description": "Size of VM"}}, "existingVnetName": {"type": "string", "metadata": {"description": "Existing VNET that contains the domain controller"}, "defaultValue": "zytest"}, "publicIPAddressName": {"type": "string", "defaultValue": "[format(\'{0}-pip\', parameters(\'dnsLabelPrefix\'))]", "metadata": {"description": "Public IP address name"}}, "existingSubnetName": {"type": "string", "metadata": {"description": "Existing subnet that contains the domain controller"}, "defaultValue": "zytest"}, "dnsLabelPrefix": {"type": "string", "maxLength": 62, "minLength": 1, "metadata": {"description": "Unique public DNS prefix for the deployment. The fqdn will look something like \'<dnsname>.westus.cloudapp.azure.com\'. Up to 62 chars, digits or dashes, lowercase, should start with a letter: must conform to \'^[a-z][a-z0-9-]{1,61}[a-z0-9]$\'."}, "defaultValue": "zytest"}, "domainToJoin": {"type": "string", "metadata": {"description": "The FQDN of the AD domain"}, "defaultValue": "zytest"}, "domainUsername": {"type": "string", "metadata": {"description": "Username of the account on the domain"}, "defaultValue": "zytest"}, "domainPassword": {"type": "secureString", "metadata": {"description": "Password of the account on the domain"}, "defaultValue": "zytest"}, "ouPath": {"type": "string", "defaultValue": "", "metadata": {"description": "Organizational Unit path in which the nodes and cluster will be present."}}, "domainJoinOptions": {"type": "int", "defaultValue": 3, "metadata": {"description": "Set of bit flags that define the join options. Default value of 3 is a combination of NETSETUP_JOIN_DOMAIN (0x00000001) & NETSETUP_ACCT_CREATE (0x00000002) i.e. will join the domain and create the account on the domain. For more information see https://msdn.microsoft.com/en-us/library/aa392154(v=vs.85).aspx"}}, "adminUsername": {"type": "string", "metadata": {"description": "The name of the administrator of the new VM."}, "defaultValue": "zytest"}, "adminPassword": {"type": "secureString", "metadata": {"description": "The password for the administrator account of the new VM."}, "defaultValue": "zytest"}, "storageAccountName": {"type": "string", "defaultValue": "zytest", "metadata": {"description": "The name of the storage account."}}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location for all resources."}}}, "variables": {"imagePublisher": "MicrosoftWindowsServer", "imageOffer": "WindowsServer", "windowsOSVersion": "2019-Datacenter", "nicName": "[format(\'{0}-nic\', parameters(\'dnsLabelPrefix\'))]"}, "resources": [{"type": "Microsoft.Network/publicIPAddresses", "apiVersion": "2021-02-01", "name": "[parameters(\'publicIPAddressName\')]", "location": "[parameters(\'location\')]", "properties": {"publicIPAllocationMethod": "Dynamic", "dnsSettings": {"domainNameLabel": "[parameters(\'dnsLabelPrefix\')]"}}}, {"type": "Microsoft.Storage/storageAccounts", "apiVersion": "2021-04-01", "name": "[parameters(\'storageAccountName\')]", "location": "[parameters(\'location\')]", "kind": "StorageV2", "sku": {"name": "Standard_LRS"}}, {"type": "Microsoft.Network/networkInterfaces", "apiVersion": "2021-02-01", "name": "[variables(\'nicName\')]", "location": "[parameters(\'location\')]", "properties": {"ipConfigurations": [{"name": "ipconfig1", "properties": {"privateIPAllocationMethod": "Dynamic", "publicIPAddress": {"id": "[resourceId(\'Microsoft.Network/publicIPAddresses\', parameters(\'publicIPAddressName\'))]"}, "subnet": {"id": "[resourceId(\'Microsoft.Network/virtualNetworks/subnets\', parameters(\'existingVnetName\'), parameters(\'existingSubnetName\'))]"}}}]}, "dependsOn": ["[resourceId(\'Microsoft.Network/publicIPAddresses\', parameters(\'publicIPAddressName\'))]"]}, {"type": "Microsoft.Compute/virtualMachines", "apiVersion": "2021-03-01", "name": "[parameters(\'dnsLabelPrefix\')]", "location": "[parameters(\'location\')]", "properties": {"hardwareProfile": {"vmSize": "[parameters(\'vmSize\')]"}, "osProfile": {"computerName": "[parameters(\'dnsLabelPrefix\')]", "adminUsername": "[parameters(\'adminUsername\')]", "adminPassword": "[parameters(\'adminPassword\')]"}, "storageProfile": {"imageReference": {"publisher": "[variables(\'imagePublisher\')]", "offer": "[variables(\'imageOffer\')]", "sku": "[variables(\'windowsOSVersion\')]", "version": "latest"}, "osDisk": {"name": "[format(\'{0}-OsDisk\', parameters(\'dnsLabelPrefix\'))]", "caching": "ReadWrite", "createOption": "FromImage"}, "dataDisks": [{"name": "[format(\'{0}-DataDisk\', parameters(\'dnsLabelPrefix\'))]", "caching": "None", "createOption": "Empty", "diskSizeGB": 1024, "lun": 0}]}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId(\'Microsoft.Network/networkInterfaces\', variables(\'nicName\'))]"}]}, "diagnosticsProfile": {"bootDiagnostics": {"enabled": true, "storageUri": "[reference(resourceId(\'Microsoft.Storage/storageAccounts\', parameters(\'storageAccountName\'))).primaryEndpoints.blob]"}}}, "dependsOn": ["[resourceId(\'Microsoft.Network/networkInterfaces\', variables(\'nicName\'))]", "[resourceId(\'Microsoft.Storage/storageAccounts\', parameters(\'storageAccountName\'))]"]}, {"type": "Microsoft.Compute/virtualMachines/extensions", "apiVersion": "2021-03-01", "name": "[format(\'{0}/{1}\', parameters(\'dnsLabelPrefix\'), \'joindomain\')]", "location": "[parameters(\'location\')]", "properties": {"publisher": "Microsoft.Compute", "type": "JsonADDomainExtension", "typeHandlerVersion": "1.3", "autoUpgradeMinorVersion": true, "settings": {"name": "[parameters(\'domainToJoin\')]", "ouPath": "[parameters(\'ouPath\')]", "user": "[format(\'{0}\\\\{1}\', parameters(\'domainToJoin\'), parameters(\'domainUsername\'))]", "restart": true, "options": "[parameters(\'domainJoinOptions\')]"}, "protectedSettings": {"Password": "[parameters(\'domainPassword\')]"}}, "dependsOn": ["[resourceId(\'Microsoft.Compute/virtualMachines\', parameters(\'dnsLabelPrefix\'))]"]}]}


cli_script
Based on the provided ARM template and parameters, below is the equivalent Azure CLI script to deploy the resources.\n\n```bash\n#!/bin/bash\n\n# Template Parameters\nvmSize="Standard_A2_v2"\nexistingVnetName="zytest"\npublicIPAddressName="$(zytest)-pip"\nexistingSubnetName="zytest"\ndnsLabelPrefix="zytest"\ndomainToJoin="zytest"\ndomainUsername="zytest"\ndomainPassword="zytest" # Note: In real script, handle secure strings securely\nouPath=""\ndomainJoinOptions=3\nadminUsername="zytest"\nadminPassword="zytest" # Note: In real script, handle secure strings securely\nstorageAccountName="zytest"\nlocation="westus"\n\n# Derived Variables\nnicName="${dnsLabelPrefix}-nic"\n\n# Create Public IP Address\naz network public-ip create \\\n    --name $publicIPAddressName \\\n    --location $location \\\n    --allocation-method Dynamic \\\n    --dns-name $dnsLabelPrefix\n\n# Create Storage Account\naz storage account create \\\n    --name $storageAccountName \\\n    --location $location \\\n    --kind StorageV2 \\\n    --sku Standard_LRS\n\n# Create Network Interface\nsubnetId=$(az network vnet subnet show --name $existingSubnetName --vnet-name $existingVnetName --query id --output tsv)\npublicIpId=$(az network public-ip show --name $publicIPAddressName --query id --output tsv)\naz network nic create \\\n    --name $nicName \\\n    --location $location \\\n    --subnet $subnetId \\\n    --public-ip-address $publicIpId\n\n# Create Virtual Machine\nosDiskName="${dnsLabelPrefix}-OsDisk"\ndataDiskName="${dnsLabelPrefix}-DataDisk"\nstorageUri=$(az storage account show --name $storageAccountName --query "primaryEndpoints.blob" --output tsv)\nnicId=$(az network nic show --name $nicName --query id --output tsv)\n\naz vm create \\\n    --name $dnsLabelPrefix \\\n    --location $location \\\n    --size $vmSize \\\n    --admin-username $adminUsername \\\n    --admin-password $adminPassword \\\n    --image MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest \\\n    --os-disk-name $osDiskName \\\n    --attach-os-disk $osDiskName \\\n    --nics $nicId \\\n    --boot-diagnostics-storage $storageAccountName\n\n# Add Data Disk to VM\naz vm disk attach \\\n    --vm-name $dnsLabelPrefix \\\n    --name $dataDiskName \\\n    --new \\\n    --size-gb 1024 \\\n    --lun 0\n\n# Join Domain Extension for VM\ndomainUser="${domainToJoin}\\\\${domainUsername}"\naz vm extension set \\\n    --vm-name $dnsLabelPrefix \\\n    --name "joindomain" \\\n    --publisher "Microsoft.Compute" \\\n    --version "1.3" \\\n    --settings "{\\"Name\\":\\"$domainToJoin\\",\\"OUPath\\":\\"$ouPath\\",\\"User\\":\\"$domainUser\\",\\"Restart\\":\\"true\\",\\"Options\\":$domainJoinOptions}" \\\n    --protected-settings "{\\"Password\\":\\"$domainPassword\\"}"\n```\n\nPlease note that the domain password and admin password are sensitive data and should be handled securely, possibly using Azure Key Vault or another secure storage mechanism. The above script assumes plain text for demonstration purposes only. Additionally, the public IP name is hardcoded to use the `dnsLabelPrefix` for simplicity; you may need to adjust the logic to match the ARM template expression if required.


verify_result
