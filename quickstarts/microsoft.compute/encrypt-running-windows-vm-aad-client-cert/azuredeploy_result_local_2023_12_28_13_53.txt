arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"vmName": {"type": "string", "metadata": {"description": "Name of the virtual machine"}, "defaultValue": "zytest"}, "aadClientID": {"type": "string", "metadata": {"description": "Client ID of AAD app which has permissions to KeyVault"}, "defaultValue": "zytest"}, "aadClientCertThumbprint": {"type": "string", "metadata": {"description": "Thumbprint of the certificate associated with the AAD app which has permissions to KeyVault"}, "defaultValue": "zytest"}, "keyVaultName": {"type": "string", "metadata": {"description": "Name of the KeyVault to place the volume encryption key"}, "defaultValue": "zytest"}, "keyVaultResourceGroup": {"type": "string", "metadata": {"description": "Resource group of the KeyVault"}, "defaultValue": "zytest"}, "useExistingKek": {"type": "string", "defaultValue": "nokek", "allowedValues": ["nokek", "kek"], "metadata": {"description": "Select kek if the secret should be encrypted with a key encryption key and pass explicit keyEncryptionKeyURL. For nokek, you can keep keyEncryptionKeyURL empty."}}, "keyEncryptionKeyURL": {"type": "string", "defaultValue": "", "metadata": {"description": "URL of the KeyEncryptionKey used to encrypt the volume encryption key"}}, "volumeType": {"type": "string", "defaultValue": "All", "metadata": {"description": "Type of the volume OS or Data to perform encryption operation"}}, "sequenceVersion": {"type": "string", "defaultValue": "1.0", "metadata": {"description": "Pass in an unique value like a GUID everytime the operation needs to be force run"}}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location for all resources."}}}, "variables": {"extensionName": "AzureDiskEncryption", "extensionVersion": "1.1", "encryptionOperation": "EnableEncryption", "keyEncryptionAlgorithm": "RSA-OAEP", "updateVmUrl": "[concat(\'https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-encrypt-running-windows-vm/updatevm-\',parameters(\'useExistingKek\'),\'.json\')]", "keyVaultURL": "[concat(\'https://\', parameters(\'keyVaultName\'), \'.vault.azure.net/\')]", "keyVaultResourceID": "[concat(subscription().id,\'/resourceGroups/\',parameters(\'keyVaultResourceGroup\'),\'/providers/Microsoft.KeyVault/vaults/\', parameters(\'keyVaultName\'))]"}, "resources": [{"type": "Microsoft.Compute/virtualMachines/extensions", "name": "[concat(parameters(\'vmName\'),\'/\', variables(\'extensionName\'))]", "apiVersion": "2016-04-30-preview", "location": "[parameters(\'location\')]", "properties": {"publisher": "Microsoft.Azure.Security", "type": "AzureDiskEncryption", "typeHandlerVersion": "[variables(\'extensionVersion\')]", "autoUpgradeMinorVersion": true, "forceUpdateTag": "[parameters(\'sequenceVersion\')]", "settings": {"AADClientID": "[parameters(\'aadClientID\')]", "AADClientCertThumbprint": "[parameters(\'aadClientCertThumbprint\')]", "KeyVaultURL": "[variables(\'keyVaultURL\')]", "KeyEncryptionKeyURL": "[parameters(\'keyEncryptionKeyURL\')]", "KeyEncryptionAlgorithm": "[variables(\'keyEncryptionAlgorithm\')]", "VolumeType": "[parameters(\'volumeType\')]", "EncryptionOperation": "[variables(\'encryptionOperation\')]"}}}, {"name": "updatevm", "type": "Microsoft.Resources/deployments", "apiVersion": "2015-01-01", "dependsOn": ["[resourceId(\'Microsoft.Compute/virtualMachines/extensions\',  parameters(\'vmName\'), variables(\'extensionName\'))]"], "properties": {"mode": "Incremental", "templateLink": {"uri": "[variables(\'updateVmUrl\')]", "contentVersion": "1.0.0.0"}, "parameters": {"vmName": {"value": "[parameters(\'vmName\')]"}, "keyVaultResourceID": {"value": "[variables(\'keyVaultResourceID\')]"}, "keyVaultSecretUrl": {"value": "[reference(resourceId(\'Microsoft.Compute/virtualMachines/extensions\',  parameters(\'vmName\'), variables(\'extensionName\'))).instanceView.statuses[0].message]"}, "keyEncryptionKeyURL": {"value": "[parameters(\'keyEncryptionKeyURL\')]"}}}}], "outputs": {"BitLockerKey": {"type": "string", "value": "[reference(resourceId(\'Microsoft.Compute/virtualMachines/extensions\',  parameters(\'vmName\'), variables(\'extensionName\'))).instanceView.statuses[0].message]"}}}


cli_script
Below is the translated bash script from the provided ARM template and parameters:\n\n```bash\n#!/bin/bash\n\n# Define variables from template parameters\nvmName="zytest"\naadClientID="zytest"\naadClientCertThumbprint="zytest"\nkeyVaultName="zytest"\nkeyVaultResourceGroup="zytest"\nuseExistingKek="nokek"\nkeyEncryptionKeyURL=""\nvolumeType="All"\nsequenceVersion="1.0"\nlocation="westus"\n\n# Define variables from ARM template variables\nextensionName="AzureDiskEncryption"\nextensionVersion="1.1"\nencryptionOperation="EnableEncryption"\nkeyEncryptionAlgorithm="RSA-OAEP"\nsubscriptionId=$(az account show --query id -o tsv)\nkeyVaultURL="https://$keyVaultName.vault.azure.net/"\nkeyVaultResourceID="/subscriptions/$subscriptionId/resourceGroups/$keyVaultResourceGroup/providers/Microsoft.KeyVault/vaults/$keyVaultName"\nupdateVmUrl="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-encrypt-running-windows-vm/updatevm-$useExistingKek.json"\n\n# Enable disk encryption on the virtual machine\naz vm extension set \\\n  --resource-group "$keyVaultResourceGroup" \\\n  --vm-name "$vmName" \\\n  --name "$extensionName" \\\n  --publisher "Microsoft.Azure.Security" \\\n  --version "$extensionVersion" \\\n  --settings "{\'AADClientID\': \'$aadClientID\', \'AADClientCertThumbprint\': \'$aadClientCertThumbprint\', \'KeyVaultURL\': \'$keyVaultURL\', \'KeyEncryptionKeyURL\': \'$keyEncryptionKeyURL\', \'KeyEncryptionAlgorithm\': \'$keyEncryptionAlgorithm\', \'VolumeType\': \'$volumeType\', \'EncryptionOperation\': \'$encryptionOperation\'}" \\\n  --force-update-tag "$sequenceVersion" \\\n  --location "$location"\n\n# Wait for the extension to be provisioned\necho "Waiting for the extension to be provisioned..."\naz vm extension wait \\\n  --resource-group "$keyVaultResourceGroup" \\\n  --vm-name "$vmName" \\\n  --name "$extensionName" \\\n  --created\n\n# Get the Key Vault Secret URL from the VM extension instance view\nkeyVaultSecretUrl=$(az vm extension show \\\n  --resource-group "$keyVaultResourceGroup" \\\n  --vm-name "$vmName" \\\n  --name "$extensionName" \\\n  --query "instanceView.statuses[0].message" \\\n  -o tsv)\n\n# Deploy the update VM template\naz deployment group create \\\n  --resource-group "$keyVaultResourceGroup" \\\n  --template-uri "$updateVmUrl" \\\n  --parameters "vmName=$vmName" "keyVaultResourceID=$keyVaultResourceID" "keyVaultSecretUrl=$keyVaultSecretUrl" "keyEncryptionKeyURL=$keyEncryptionKeyURL"\n\n# Output the BitLocker key\nbitLockerKey=$(az vm extension show \\\n  --resource-group "$keyVaultResourceGroup" \\\n  --vm-name "$vmName" \\\n  --name "$extensionName" \\\n  --query "instanceView.statuses[0].message" \\\n  -o tsv)\necho "BitLockerKey: $bitLockerKey"\n```\n\nPlease note that this script assumes that you have the Azure CLI installed and configured with the correct permissions to create and manage these resources. Also, the script assumes that the resources (like KeyVault and Virtual Machine) are already created and available in the specified location and resource group. The script is ready to be executed in a bash environment.


verify_result
{"diff_info": ["  ", "  Thedeploymentwillupdatethefollowingscope:", "  ", "  Scope:/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg", "  ", "  -Microsoft.CognitiveServices/accounts/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.CognitiveServices/accounts/cli-translator\\"", "  identity.type:\\"None\\"", "  kind:\\"FormRecognizer\\"", "  location:\\"westus2\\"", "  name:\\"cli-translator\\"", "  sku.name:\\"F0\\"", "  type:\\"Microsoft.CognitiveServices/accounts\\"", "  ", "  -Microsoft.DocumentDb/databaseAccounts/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.DocumentDb/databaseAccounts/cli-translator\\"", "  identity.type:\\"None\\"", "  kind:\\"GlobalDocumentDB\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  tags.defaultExperience:\\"Core(SQL)\\"", "  type:\\"Microsoft.DocumentDb/databaseAccounts\\"", "  ", "  -Microsoft.Search/searchServices/customdatasearch", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Search/searchServices/customdatasearch\\"", "  location:\\"westus2\\"", "  name:\\"customdatasearch\\"", "  sku.name:\\"standard\\"", "  tags.ProjectType:\\"aoai-your-data-service\\"", "  type:\\"Microsoft.Search/searchServices\\"", "  ", "  -Microsoft.Storage/storageAccounts/clitranslatorapi", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/clitranslatorapi\\"", "  kind:\\"Storage\\"", "  location:\\"westus\\"", "  name:\\"clitranslatorapi\\"", "  sku.name:\\"Standard_LRS\\"", "  sku.tier:\\"Standard\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Storage/storageAccounts/customdataforgpt", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/customdataforgpt\\"", "  kind:\\"StorageV2\\"", "  location:\\"eastus\\"", "  name:\\"customdataforgpt\\"", "  sku.name:\\"Standard_RAGRS\\"", "  sku.tier:\\"Standard\\"", "  tags.ProjectType:\\"aoai-your-data-service\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Storage/storageAccounts/translatortempfiles", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/translatortempfiles\\"", "  kind:\\"StorageV2\\"", "  location:\\"eastasia\\"", "  name:\\"translatortempfiles\\"", "  sku.name:\\"Standard_LRS\\"", "  sku.tier:\\"Standard\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Web/serverFarms/ASP-clitranslatorrg-bdc9", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Web/serverFarms/ASP-clitranslatorrg-bdc9\\"", "  kind:\\"functionapp\\"", "  location:\\"westus\\"", "  name:\\"ASP-clitranslatorrg-bdc9\\"", "  sku.capacity:0", "  sku.family:\\"Y\\"", "  sku.name:\\"Y1\\"", "  sku.size:\\"Y1\\"", "  sku.tier:\\"Dynamic\\"", "  type:\\"Microsoft.Web/serverFarms\\"", "  ", "  -Microsoft.Web/sites/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Web/sites/cli-translator\\"", "  kind:\\"functionapp,linux\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  tags.hidden-link:/app-insights-conn-string:\\"InstrumentationKey=11b638ce-0c16-42cc-9516-58122a1922ef;IngestionEndpoint=https://westus-0.in.applicationinsights.azure.com/;LiveEndpoint=https://westus.livediagnostics.monitor.azure.com/\\"", "  tags.hidden-link:/app-insights-instrumentation-key:\\"11b638ce-0c16-42cc-9516-58122a1922ef\\"", "  tags.hidden-link:/app-insights-resource-id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.insights/components/cli-translator\\"", "  type:\\"Microsoft.Web/sites\\"", "  ", "  -microsoft.alertsmanagement/smartDetectorAlertRules/FailureAnomalies-cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.alertsmanagement/smartDetectorAlertRules/FailureAnomalies-cli-translator\\"", "  location:\\"global\\"", "  name:\\"FailureAnomalies-cli-translator\\"", "  type:\\"microsoft.alertsmanagement/smartDetectorAlertRules\\"", "  ", "  -microsoft.insights/components/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.insights/components/cli-translator\\"", "  kind:\\"web\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  type:\\"microsoft.insights/components\\"", "  ", "- +Microsoft.Compute/virtualMachines/zytest/extensions/AzureDiskEncryption[-preview]", "?                                                                          --------\\n", "+ +Microsoft.Compute/virtualMachines/zytest/extensions/AzureDiskEncryption[]", "  ", "- apiVersion:\\"-preview\\"", "?             --------\\n", "+ apiVersion:\\"\\"", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Compute/virtualMachines/zytest/extensions/AzureDiskEncryption\\"", "  location:\\"westus\\"", "  name:\\"AzureDiskEncryption\\"", "  properties.autoUpgradeMinorVersion:true", "- properties.forceUpdateTag:\\"1.0\\"", "+ properties.protectedSettings:\\"*******\\"", "  properties.publisher:\\"Microsoft.Azure.Security\\"", "  properties.settings.AADClientCertThumbprint:\\"zytest\\"", "  properties.settings.AADClientID:\\"zytest\\"", "  properties.settings.EncryptionOperation:\\"EnableEncryption\\"", "  properties.settings.KeyEncryptionAlgorithm:\\"RSA-OAEP\\"", "  properties.settings.KeyVaultURL:\\"https://zytest.vault.azure.net/\\"", "  properties.settings.VolumeType:\\"All\\"", "  properties.type:\\"AzureDiskEncryption\\"", "  properties.typeHandlerVersion:\\"1.1\\"", "  type:\\"Microsoft.Compute/virtualMachines/extensions\\"", "  ", "  Resourcechanges:10todelete,1tocreate."], "diff_summary": {"added": 3, "deleted": 3, "differential_rate": "0.048"}}