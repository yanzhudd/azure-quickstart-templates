arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"vmNames": {"type": "array", "metadata": {"description": "Names of the virtual machines"}, "defaultValue": "zytest"}, "omsWorkspaceName": {"type": "string", "metadata": {"description": "Name of the OMS workspace"}, "defaultValue": "zytest"}, "location": {"type": "string", "metadata": {"description": "Location of the resources"}, "defaultValue": "westus"}, "resourceGroupName": {"type": "string", "metadata": {"description": "Name of the resource group for the resources"}, "defaultValue": "zytest"}}, "resources": [{"type": "Microsoft.Compute/virtualMachines/extensions", "name": "[concat(concat(parameters(\'vmNames\')[copyIndex()]),\'/OMSExtension\')]", "apiVersion": "2020-12-01", "location": "[parameters(\'location\')]", "copy": {"name": "copy-monitoring-agent", "count": 2}, "properties": {"publisher": "Microsoft.EnterpriseCloud.Monitoring", "type": "MicrosoftMonitoringAgent", "typeHandlerVersion": "1.0", "autoUpgradeMinorVersion": true, "settings": {"workspaceId": "[reference(resourceId(parameters(\'resourceGroupName\'),\'Microsoft.OperationalInsights/workspaces/\', parameters(\'omsWorkspaceName\')), \'2021-06-01\').customerId]"}, "protectedSettings": {"workspaceKey": "[listKeys(resourceId(parameters(\'resourceGroupName\'),\'Microsoft.OperationalInsights/workspaces/\', parameters(\'omsWorkspaceName\')), \'2021-06-01\').primarySharedKey]"}}}]}


cli_script
Here is the equivalent CLI script:\n\n```bash\n#!/bin/bash\n\n# Define parameters\nvmNames=("zytest")\nomsWorkspaceName="zytest"\nlocation="westus"\nresourceGroupName="zytest"\n\n# Get workspaceId and workspaceKey\nworkspaceId=$(az resource show --id "/subscriptions/{subscriptionId}/resourceGroups/$resourceGroupName/providers/Microsoft.OperationalInsights/workspaces/$omsWorkspaceName" --query properties.customerId --output tsv)\nworkspaceKey=$(az rest --method post --uri "/subscriptions/{subscriptionId}/resourceGroups/$resourceGroupName/providers/Microsoft.OperationalInsights/workspaces/$omsWorkspaceName/sharedKeys?api-version=2021-06-01" --query primarySharedKey --output tsv)\n\n# Create virtual machine extensions\nfor vmName in "${vmNames[@]}"\ndo\n    az vm extension set \\\n        --resource-group $resourceGroupName \\\n        --vm-name $vmName \\\n        --name OMSExtension \\\n        --publisher Microsoft.EnterpriseCloud.Monitoring \\\n        --version 1.0 \\\n        --settings "{\'workspaceId\': \'$workspaceId\'}" \\\n        --protected-settings "{\'workspaceKey\': \'$workspaceKey\'}"\ndone\n```\n\nPlease replace `{subscriptionId}` with your actual Azure subscription ID.


verify_result
