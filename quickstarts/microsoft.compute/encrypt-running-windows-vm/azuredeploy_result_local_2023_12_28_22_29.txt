arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "parameters": {"vmName": {"type": "string", "metadata": {"description": "Name of the virtual machine."}, "defaultValue": "zytest"}, "keyVaultName": {"type": "string", "metadata": {"description": "Name of the KeyVault to place the volume encryption key"}, "defaultValue": "zytest"}, "enabledForDeployment": {"type": "bool", "defaultValue": true, "metadata": {"description": "Specifies whether Azure Virtual Machines are permitted to retrieve certificates stored as secrets from the key vault."}}, "enabledForDiskEncryption": {"type": "bool", "defaultValue": true, "metadata": {"description": "Specifies whether Azure Disk Encryption is permitted to retrieve secrets from the vault and unwrap keys."}}, "enabledForTemplateDeployment": {"type": "bool", "defaultValue": true, "metadata": {"description": "Specifies whether Azure Resource Manager is permitted to retrieve secrets from the key vault."}}, "keysPermissions": {"type": "array", "defaultValue": ["list", "get", "decrypt", "encrypt", "unwrapkey", "wrapkey"], "metadata": {"description": "Specifies the permissions to keys in the vault. Valid values are: all, encrypt, decrypt, wrapKey, unwrapKey, sign, verify, get, list, create, update, import, delete, backup, restore, recover, and purge."}}, "secretsPermissions": {"type": "array", "defaultValue": ["list", "get"], "metadata": {"description": "Specifies the permissions to secrets in the vault. Valid values are: all, get, list, set, delete, backup, restore, recover, and purge."}}, "skuName": {"type": "string", "defaultValue": "Standard", "allowedValues": ["Standard", "Premium"], "metadata": {"description": "Specifies whether the key vault is a standard vault or a premium vault."}}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location of the resources."}}}, "variables": {"keyVaultURL": "[concat(\'https://\', parameters(\'keyVaultName\'), environment().suffixes.keyVaultDns)]", "encryptionOperation": "EnableEncryption"}, "resources": [{"type": "Microsoft.KeyVault/vaults", "apiVersion": "2021-04-01-preview", "name": "[parameters(\'keyVaultName\')]", "location": "[parameters(\'location\')]", "properties": {"enabledForDeployment": "[parameters(\'enabledForDeployment\')]", "enabledForDiskEncryption": "[parameters(\'enabledForDiskEncryption\')]", "enabledForTemplateDeployment": "[parameters(\'enabledForTemplateDeployment\')]", "tenantId": "[subscription().tenantId]", "accessPolicies": [{"objectId": "[reference(resourceId(\'Microsoft.Compute/virtualMachines/\', parameters(\'vmName\')), \'2020-12-01\', \'full\').identity.principalId]", "tenantId": "[subscription().tenantId]", "permissions": {"keys": "[parameters(\'keysPermissions\')]", "secrets": "[parameters(\'secretsPermissions\')]"}}], "sku": {"name": "[parameters(\'skuName\')]", "family": "A"}, "networkAcls": {"defaultAction": "Allow", "bypass": "AzureServices"}}}, {"type": "Microsoft.Compute/virtualMachines/extensions", "name": "[concat(parameters(\'vmName\'),\'/diskEncryption\')]", "apiVersion": "2020-12-01", "dependsOn": ["[resourceId(\'Microsoft.KeyVault/vaults\', parameters(\'keyVaultName\'))]"], "location": "[parameters(\'location\')]", "properties": {"publisher": "Microsoft.Azure.Security", "type": "AzureDiskEncryption", "typeHandlerVersion": "2.2", "autoUpgradeMinorVersion": true, "settings": {"EncryptionOperation": "[variables(\'encryptionOperation\')]", "KeyVaultURL": "[variables(\'keyVaultURL\')]", "KeyVaultResourceId": "[resourceId(\'Microsoft.KeyVault/vaults/\', parameters(\'keyVaultName\'))]", "VolumeType": "All"}}}]}


cli_script
```bash\n#!/bin/bash\n\n# Assign template parameter values to variables\nvmName="zytest"\nkeyVaultName="zytest"\nenabledForDeployment=true\nenabledForDiskEncryption=true\nenabledForTemplateDeployment=true\nkeysPermissions=("list" "get" "decrypt" "encrypt" "unwrapkey" "wrapkey")\nsecretsPermissions=("list" "get")\nskuName="Standard"\nlocation="westus"\n\n# Create Key Vault\naz keyvault create \\\n    --name $keyVaultName \\\n    --location $location \\\n    --enabled-for-deployment $enabledForDeployment \\\n    --enabled-for-disk-encryption $enabledForDiskEncryption \\\n    --enabled-for-template-deployment $enabledForTemplateDeployment \\\n    --sku $skuName \\\n    --network-acls-default-action "Allow" \\\n    --network-acls-bypass "AzureServices"\n\n# Retrieve the Tenant ID\ntenantId=$(az account show --query tenantId -o tsv)\n\n# Retrieve the Principal ID of the VM\nprincipalId=$(az vm show \\\n    --name $vmName \\\n    --query identity.principalId -o tsv)\n\n# Add an access policy to the Key Vault for the VM\naz keyvault set-policy \\\n    --name $keyVaultName \\\n    --object-id $principalId \\\n    --key-permissions ${keysPermissions[@]} \\\n    --secret-permissions ${secretsPermissions[@]} \\\n    --tenant-id $tenantId\n\n# Retrieve the Key Vault URI\nkeyVaultURL=$(az keyvault show \\\n    --name $keyVaultName \\\n    --query "properties.vaultUri" -o tsv)\n\n# Enable disk encryption on the VM\naz vm extension set \\\n    --publisher "Microsoft.Azure.Security" \\\n    --version "2.2" \\\n    --name "AzureDiskEncryption" \\\n    --vm-name $vmName \\\n    --settings "{\\"EncryptionOperation\\":\\"EnableEncryption\\",\\"KeyVaultURL\\":\\"$keyVaultURL\\",\\"KeyVaultResourceId\\":\\"$(az keyvault show --name $keyVaultName --query id -o tsv)\\",\\"VolumeType\\":\\"All\\"}"\n```\n\nThe above bash script translates the provided ARM template and parameters into CLI commands. It creates a Key Vault, sets up access policies, and enables disk encryption on the specified virtual machine. Please ensure that the CLI version you are using supports these commands and parameters.


verify_result
{"diff_info": ["  ", "  Thedeploymentwillupdatethefollowingscope:", "  ", "  Scope:/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg", "  ", "  -Microsoft.CognitiveServices/accounts/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.CognitiveServices/accounts/cli-translator\\"", "  identity.type:\\"None\\"", "  kind:\\"FormRecognizer\\"", "  location:\\"westus2\\"", "  name:\\"cli-translator\\"", "  sku.name:\\"F0\\"", "  type:\\"Microsoft.CognitiveServices/accounts\\"", "  ", "  -Microsoft.DocumentDb/databaseAccounts/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.DocumentDb/databaseAccounts/cli-translator\\"", "  identity.type:\\"None\\"", "  kind:\\"GlobalDocumentDB\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  tags.defaultExperience:\\"Core(SQL)\\"", "  type:\\"Microsoft.DocumentDb/databaseAccounts\\"", "  ", "  -Microsoft.Search/searchServices/customdatasearch", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Search/searchServices/customdatasearch\\"", "  location:\\"westus2\\"", "  name:\\"customdatasearch\\"", "  sku.name:\\"standard\\"", "  tags.ProjectType:\\"aoai-your-data-service\\"", "  type:\\"Microsoft.Search/searchServices\\"", "  ", "  -Microsoft.Storage/storageAccounts/clitranslatorapi", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/clitranslatorapi\\"", "  kind:\\"Storage\\"", "  location:\\"westus\\"", "  name:\\"clitranslatorapi\\"", "  sku.name:\\"Standard_LRS\\"", "  sku.tier:\\"Standard\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Storage/storageAccounts/customdataforgpt", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/customdataforgpt\\"", "  kind:\\"StorageV2\\"", "  location:\\"eastus\\"", "  name:\\"customdataforgpt\\"", "  sku.name:\\"Standard_RAGRS\\"", "  sku.tier:\\"Standard\\"", "  tags.ProjectType:\\"aoai-your-data-service\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Storage/storageAccounts/translatortempfiles", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Storage/storageAccounts/translatortempfiles\\"", "  kind:\\"StorageV2\\"", "  location:\\"eastasia\\"", "  name:\\"translatortempfiles\\"", "  sku.name:\\"Standard_LRS\\"", "  sku.tier:\\"Standard\\"", "  type:\\"Microsoft.Storage/storageAccounts\\"", "  ", "  -Microsoft.Web/serverFarms/ASP-clitranslatorrg-bdc9", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Web/serverFarms/ASP-clitranslatorrg-bdc9\\"", "  kind:\\"functionapp\\"", "  location:\\"westus\\"", "  name:\\"ASP-clitranslatorrg-bdc9\\"", "  sku.capacity:0", "  sku.family:\\"Y\\"", "  sku.name:\\"Y1\\"", "  sku.size:\\"Y1\\"", "  sku.tier:\\"Dynamic\\"", "  type:\\"Microsoft.Web/serverFarms\\"", "  ", "  -Microsoft.Web/sites/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Web/sites/cli-translator\\"", "  kind:\\"functionapp,linux\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  tags.hidden-link:/app-insights-conn-string:\\"InstrumentationKey=11b638ce-0c16-42cc-9516-58122a1922ef;IngestionEndpoint=https://westus-0.in.applicationinsights.azure.com/;LiveEndpoint=https://westus.livediagnostics.monitor.azure.com/\\"", "  tags.hidden-link:/app-insights-instrumentation-key:\\"11b638ce-0c16-42cc-9516-58122a1922ef\\"", "  tags.hidden-link:/app-insights-resource-id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.insights/components/cli-translator\\"", "  type:\\"Microsoft.Web/sites\\"", "  ", "  -microsoft.alertsmanagement/smartDetectorAlertRules/FailureAnomalies-cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.alertsmanagement/smartDetectorAlertRules/FailureAnomalies-cli-translator\\"", "  location:\\"global\\"", "  name:\\"FailureAnomalies-cli-translator\\"", "  type:\\"microsoft.alertsmanagement/smartDetectorAlertRules\\"", "  ", "  -microsoft.insights/components/cli-translator", "  ", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/microsoft.insights/components/cli-translator\\"", "  kind:\\"web\\"", "  location:\\"westus\\"", "  name:\\"cli-translator\\"", "  type:\\"microsoft.insights/components\\"", "  ", "- +Microsoft.Compute/virtualMachines/zytest/extensions/diskEncryption[]", "?                                                      ^\\n", "+ +Microsoft.Compute/virtualMachines/zytest/extensions/AzureDiskEncryption[]", "?                                                      ^^^^^^\\n", "  ", "  apiVersion:\\"\\"", "- id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Compute/virtualMachines/zytest/extensions/diskEncryption\\"", "?                                                                                                                                                        ^\\n", "+ id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.Compute/virtualMachines/zytest/extensions/AzureDiskEncryption\\"", "?                                                                                                                                                        ^^^^^^\\n", "  location:\\"westus\\"", "- name:\\"diskEncryption\\"", "?       ^\\n", "+ name:\\"AzureDiskEncryption\\"", "?       ^^^^^^\\n", "  properties.autoUpgradeMinorVersion:true", "  properties.publisher:\\"Microsoft.Azure.Security\\"", "  properties.settings.EncryptionOperation:\\"EnableEncryption\\"", "  properties.settings.KeyVaultResourceId:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.KeyVault/vaults/zytest\\"", "- properties.settings.KeyVaultURL:\\"https://zytest.vault.azure.net\\"", "+ properties.settings.KeyVaultURL:\\"[reference(resourceId(\'Microsoft.KeyVault/vaults\',parameters(\'keyVaultName\')),\'\').properties.vaultUri]\\"", "  properties.settings.VolumeType:\\"All\\"", "  properties.type:\\"AzureDiskEncryption\\"", "  properties.typeHandlerVersion:\\"2.2\\"", "  type:\\"Microsoft.Compute/virtualMachines/extensions\\"", "  ", "- +Microsoft.KeyVault/vaults/zytest[-preview]", "?                                   --------\\n", "+ +Microsoft.KeyVault/vaults/zytest[]", "  ", "- apiVersion:\\"-preview\\"", "?             --------\\n", "+ apiVersion:\\"\\"", "  id:\\"/subscriptions/6b085460-5f21-477e-ba44-1035046e9101/resourceGroups/cli-translator-rg/providers/Microsoft.KeyVault/vaults/zytest\\"", "  location:\\"westus\\"", "  name:\\"zytest\\"", "  properties.accessPolicies:[", "  0:", "  ", "- objectId:\\"[reference(resourceId(\'Microsoft.Compute/virtualMachines/\',parameters(\'vmName\')),\'\',\'full\').identity.principalId]\\"", "?                                                                   -                            ^\\n", "+ objectId:\\"[reference(resourceId(\'Microsoft.Compute/virtualMachines\',parameters(\'vmName\')),\'\',\'Full\').identity.principalId]\\"", "?                                                                                               ^\\n", "  permissions.keys:[", "  0:\\"list\\"", "  1:\\"get\\"", "  2:\\"decrypt\\"", "  3:\\"encrypt\\"", "  4:\\"unwrapkey\\"", "  5:\\"wrapkey\\"", "  ]", "  permissions.secrets:[", "  0:\\"list\\"", "  1:\\"get\\"", "  ]", "  tenantId:\\"72f988bf-86f1-41af-91ab-2d7cd011db47\\"", "  ", "  ]", "  properties.enabledForDeployment:true", "  properties.enabledForDiskEncryption:true", "  properties.enabledForTemplateDeployment:true", "  properties.enableSoftDelete:true", "  properties.networkAcls.bypass:\\"AzureServices\\"", "  properties.networkAcls.defaultAction:\\"Allow\\"", "  properties.sku.family:\\"A\\"", "  properties.sku.name:\\"Standard\\"", "  properties.tenantId:\\"72f988bf-86f1-41af-91ab-2d7cd011db47\\"", "  type:\\"Microsoft.KeyVault/vaults\\"", "  ", "  Resourcechanges:10todelete,2tocreate."], "diff_summary": {"added": 7, "deleted": 7, "differential_rate": "0.089"}}