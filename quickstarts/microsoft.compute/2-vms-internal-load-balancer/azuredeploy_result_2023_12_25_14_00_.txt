arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "metadata": {"_generator": {"name": "bicep", "version": "0.5.6.12127", "templateHash": "12604669370283105560"}}, "parameters": {"adminUsername": {"type": "string", "metadata": {"description": "Admin username"}, "defaultValue": "zytest"}, "adminPassword": {"type": "secureString", "metadata": {"description": "Admin password"}, "defaultValue": "zytest"}, "vmNamePrefix": {"type": "string", "defaultValue": "BackendVM", "metadata": {"description": "Prefix to use for VM names"}}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location for all resources."}}, "vmSize": {"type": "string", "defaultValue": "Standard_D2s_v3", "metadata": {"description": "Size of the virtual machines"}}}, "variables": {"availabilitySetName": "AvSet", "storageAccountType": "Standard_LRS", "storageAccountName": "zytest", "virtualNetworkName": "vNet", "subnetName": "backendSubnet", "loadBalancerName": "ilb", "networkInterfaceName": "nic", "subnetRef": "[resourceId(\'Microsoft.Network/virtualNetworks/subnets\', variables(\'virtualNetworkName\'), variables(\'subnetName\'))]", "numberOfInstances": 2}, "resources": [{"type": "Microsoft.Storage/storageAccounts", "apiVersion": "2021-08-01", "name": "[variables(\'storageAccountName\')]", "location": "[parameters(\'location\')]", "sku": {"name": "[variables(\'storageAccountType\')]"}, "kind": "StorageV2"}, {"type": "Microsoft.Compute/availabilitySets", "apiVersion": "2021-11-01", "name": "[variables(\'availabilitySetName\')]", "location": "[parameters(\'location\')]", "sku": {"name": "Aligned"}, "properties": {"platformUpdateDomainCount": 2, "platformFaultDomainCount": 2}}, {"type": "Microsoft.Network/virtualNetworks", "apiVersion": "2021-05-01", "name": "[variables(\'virtualNetworkName\')]", "location": "[parameters(\'location\')]", "properties": {"addressSpace": {"addressPrefixes": ["10.0.0.0/16"]}, "subnets": [{"name": "[variables(\'subnetName\')]", "properties": {"addressPrefix": "10.0.2.0/24"}}]}}, {"copy": {"name": "networkInterface", "count": "[length(range(0, variables(\'numberOfInstances\')))]"}, "type": "Microsoft.Network/networkInterfaces", "apiVersion": "2021-05-01", "name": "[format(\'{0}{1}\', variables(\'networkInterfaceName\'), range(0, variables(\'numberOfInstances\'))[copyIndex()])]", "location": "[parameters(\'location\')]", "properties": {"ipConfigurations": [{"name": "ipconfig1", "properties": {"privateIPAllocationMethod": "Dynamic", "subnet": {"id": "[variables(\'subnetRef\')]"}, "loadBalancerBackendAddressPools": [{"id": "[resourceId(\'Microsoft.Network/loadBalancers/backendAddressPools\', variables(\'loadBalancerName\'), \'BackendPool1\')]"}]}}]}, "dependsOn": ["[resourceId(\'Microsoft.Network/loadBalancers\', variables(\'loadBalancerName\'))]", "[resourceId(\'Microsoft.Network/virtualNetworks\', variables(\'virtualNetworkName\'))]"]}, {"type": "Microsoft.Network/loadBalancers", "apiVersion": "2021-05-01", "name": "[variables(\'loadBalancerName\')]", "location": "[parameters(\'location\')]", "sku": {"name": "Standard"}, "properties": {"frontendIPConfigurations": [{"properties": {"subnet": {"id": "[variables(\'subnetRef\')]"}, "privateIPAddress": "10.0.2.6", "privateIPAllocationMethod": "Static"}, "name": "LoadBalancerFrontend"}], "backendAddressPools": [{"name": "BackendPool1"}], "loadBalancingRules": [{"properties": {"frontendIPConfiguration": {"id": "[resourceId(\'Microsoft.Network/loadBalancers/frontendIpConfigurations\', variables(\'loadBalancerName\'), \'LoadBalancerFrontend\')]"}, "backendAddressPool": {"id": "[resourceId(\'Microsoft.Network/loadBalancers/backendAddressPools\', variables(\'loadBalancerName\'), \'BackendPool1\')]"}, "probe": {"id": "[resourceId(\'Microsoft.Network/loadBalancers/probes\', variables(\'loadBalancerName\'), \'lbprobe\')]"}, "protocol": "Tcp", "frontendPort": 80, "backendPort": 80, "idleTimeoutInMinutes": 15}, "name": "lbrule"}], "probes": [{"properties": {"protocol": "Tcp", "port": 80, "intervalInSeconds": 15, "numberOfProbes": 2}, "name": "lbprobe"}]}, "dependsOn": ["[resourceId(\'Microsoft.Network/virtualNetworks\', variables(\'virtualNetworkName\'))]"]}, {"copy": {"name": "vm", "count": "[length(range(0, variables(\'numberOfInstances\')))]"}, "type": "Microsoft.Compute/virtualMachines", "apiVersion": "2021-11-01", "name": "[format(\'{0}{1}\', parameters(\'vmNamePrefix\'), range(0, variables(\'numberOfInstances\'))[copyIndex()])]", "location": "[parameters(\'location\')]", "properties": {"availabilitySet": {"id": "[resourceId(\'Microsoft.Compute/availabilitySets\', variables(\'availabilitySetName\'))]"}, "hardwareProfile": {"vmSize": "[parameters(\'vmSize\')]"}, "osProfile": {"computerName": "[format(\'{0}{1}\', parameters(\'vmNamePrefix\'), range(0, variables(\'numberOfInstances\'))[copyIndex()])]", "adminUsername": "[parameters(\'adminUsername\')]", "adminPassword": "[parameters(\'adminPassword\')]"}, "storageProfile": {"imageReference": {"publisher": "MicrosoftWindowsServer", "offer": "WindowsServer", "sku": "2019-Datacenter", "version": "latest"}, "osDisk": {"createOption": "FromImage"}}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId(\'Microsoft.Network/networkInterfaces\', format(\'{0}{1}\', variables(\'networkInterfaceName\'), range(0, variables(\'numberOfInstances\'))[range(0, variables(\'numberOfInstances\'))[copyIndex()]]))]"}]}, "diagnosticsProfile": {"bootDiagnostics": {"enabled": true, "storageUri": "[reference(resourceId(\'Microsoft.Storage/storageAccounts\', variables(\'storageAccountName\'))).primaryEndpoints.blob]"}}}, "dependsOn": ["[resourceId(\'Microsoft.Compute/availabilitySets\', variables(\'availabilitySetName\'))]", "[resourceId(\'Microsoft.Network/networkInterfaces\', format(\'{0}{1}\', variables(\'networkInterfaceName\'), range(0, variables(\'numberOfInstances\'))[range(0, variables(\'numberOfInstances\'))[copyIndex()]]))]", "[resourceId(\'Microsoft.Storage/storageAccounts\', variables(\'storageAccountName\'))]"]}]}


cli_script
Here is the equivalent CLI script:\n\n```bash\n#!/bin/bash\n\n# Define parameters\nadminUsername="zytest"\nadminPassword="zytest"\nvmNamePrefix="BackendVM"\nlocation="westus"\nvmSize="Standard_D2s_v3"\n\n# Define variables\navailabilitySetName="AvSet"\nstorageAccountType="Standard_LRS"\nstorageAccountName="zytest"\nvirtualNetworkName="vNet"\nsubnetName="backendSubnet"\nloadBalancerName="ilb"\nnetworkInterfaceName="nic"\nnumberOfInstances=2\n\n# Create storage account\naz storage account create --name $storageAccountName --location $location --sku $storageAccountType --kind StorageV2\n\n# Create availability set\naz vm availability-set create --name $availabilitySetName --location $location --platform-fault-domain-count 2 --platform-update-domain-count 2 --sku Aligned\n\n# Create virtual network\naz network vnet create --name $virtualNetworkName --location $location --address-prefix 10.0.0.0/16\n\n# Create subnet\naz network vnet subnet create --name $subnetName --vnet-name $virtualNetworkName --address-prefix 10.0.2.0/24\n\n# Create load balancer\naz network lb create --name $loadBalancerName --location $location --frontend-ip-name LoadBalancerFrontend --private-ip-address 10.0.2.6 --backend-pool-name BackendPool1 --sku Standard\n\n# Create network interfaces\nfor i in $(seq 1 $numberOfInstances)\ndo\n    az network nic create --name "${networkInterfaceName}${i}" --vnet-name $virtualNetworkName --subnet $subnetName --lb-name $loadBalancerName --lb-address-pools BackendPool1\ndone\n\n# Create virtual machines\nfor i in $(seq 1 $numberOfInstances)\ndo\n    az vm create --name "${vmNamePrefix}${i}" --location $location --availability-set $availabilitySetName --size $vmSize --admin-username $adminUsername --admin-password $adminPassword --image MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest --nics "${networkInterfaceName}${i}" --storage-account $storageAccountName\ndone\n```\n\nPlease replace the actual values of the parameters and variables in the script.


verify_result
