arm_template
{"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#", "contentVersion": "1.0.0.0", "metadata": {"_generator": {"name": "bicep", "version": "0.5.6.12127", "templateHash": "16594126968631223272"}}, "parameters": {"vmSize": {"type": "string", "defaultValue": "Standard_A2_v2", "metadata": {"description": "Size of VM"}}, "existingVnetName": {"type": "string", "metadata": {"description": "Existing VNET that contains the domain controller"}, "defaultValue": "zytest"}, "publicIPAddressName": {"type": "string", "defaultValue": "[format(\'{0}-pip\', parameters(\'dnsLabelPrefix\'))]", "metadata": {"description": "Public IP address name"}}, "existingSubnetName": {"type": "string", "metadata": {"description": "Existing subnet that contains the domain controller"}, "defaultValue": "zytest"}, "dnsLabelPrefix": {"type": "string", "maxLength": 62, "minLength": 1, "metadata": {"description": "Unique public DNS prefix for the deployment. The fqdn will look something like \'<dnsname>.westus.cloudapp.azure.com\'. Up to 62 chars, digits or dashes, lowercase, should start with a letter: must conform to \'^[a-z][a-z0-9-]{1,61}[a-z0-9]$\'."}, "defaultValue": "zytest"}, "domainToJoin": {"type": "string", "metadata": {"description": "The FQDN of the AD domain"}, "defaultValue": "zytest"}, "domainUsername": {"type": "string", "metadata": {"description": "Username of the account on the domain"}, "defaultValue": "zytest"}, "domainPassword": {"type": "secureString", "metadata": {"description": "Password of the account on the domain"}, "defaultValue": "zytest"}, "ouPath": {"type": "string", "defaultValue": "", "metadata": {"description": "Organizational Unit path in which the nodes and cluster will be present."}}, "domainJoinOptions": {"type": "int", "defaultValue": 3, "metadata": {"description": "Set of bit flags that define the join options. Default value of 3 is a combination of NETSETUP_JOIN_DOMAIN (0x00000001) & NETSETUP_ACCT_CREATE (0x00000002) i.e. will join the domain and create the account on the domain. For more information see https://msdn.microsoft.com/en-us/library/aa392154(v=vs.85).aspx"}}, "adminUsername": {"type": "string", "metadata": {"description": "The name of the administrator of the new VM."}, "defaultValue": "zytest"}, "adminPassword": {"type": "secureString", "metadata": {"description": "The password for the administrator account of the new VM."}, "defaultValue": "zytest"}, "storageAccountName": {"type": "string", "defaultValue": "zytest", "metadata": {"description": "The name of the storage account."}}, "location": {"type": "string", "defaultValue": "westus", "metadata": {"description": "Location for all resources."}}}, "variables": {"imagePublisher": "MicrosoftWindowsServer", "imageOffer": "WindowsServer", "windowsOSVersion": "2019-Datacenter", "nicName": "[format(\'{0}-nic\', parameters(\'dnsLabelPrefix\'))]"}, "resources": [{"type": "Microsoft.Network/publicIPAddresses", "apiVersion": "2021-02-01", "name": "[parameters(\'publicIPAddressName\')]", "location": "[parameters(\'location\')]", "properties": {"publicIPAllocationMethod": "Dynamic", "dnsSettings": {"domainNameLabel": "[parameters(\'dnsLabelPrefix\')]"}}}, {"type": "Microsoft.Storage/storageAccounts", "apiVersion": "2021-04-01", "name": "[parameters(\'storageAccountName\')]", "location": "[parameters(\'location\')]", "kind": "StorageV2", "sku": {"name": "Standard_LRS"}}, {"type": "Microsoft.Network/networkInterfaces", "apiVersion": "2021-02-01", "name": "[variables(\'nicName\')]", "location": "[parameters(\'location\')]", "properties": {"ipConfigurations": [{"name": "ipconfig1", "properties": {"privateIPAllocationMethod": "Dynamic", "publicIPAddress": {"id": "[resourceId(\'Microsoft.Network/publicIPAddresses\', parameters(\'publicIPAddressName\'))]"}, "subnet": {"id": "[resourceId(\'Microsoft.Network/virtualNetworks/subnets\', parameters(\'existingVnetName\'), parameters(\'existingSubnetName\'))]"}}}]}, "dependsOn": ["[resourceId(\'Microsoft.Network/publicIPAddresses\', parameters(\'publicIPAddressName\'))]"]}, {"type": "Microsoft.Compute/virtualMachines", "apiVersion": "2021-03-01", "name": "[parameters(\'dnsLabelPrefix\')]", "location": "[parameters(\'location\')]", "properties": {"hardwareProfile": {"vmSize": "[parameters(\'vmSize\')]"}, "osProfile": {"computerName": "[parameters(\'dnsLabelPrefix\')]", "adminUsername": "[parameters(\'adminUsername\')]", "adminPassword": "[parameters(\'adminPassword\')]"}, "storageProfile": {"imageReference": {"publisher": "[variables(\'imagePublisher\')]", "offer": "[variables(\'imageOffer\')]", "sku": "[variables(\'windowsOSVersion\')]", "version": "latest"}, "osDisk": {"name": "[format(\'{0}-OsDisk\', parameters(\'dnsLabelPrefix\'))]", "caching": "ReadWrite", "createOption": "FromImage"}, "dataDisks": [{"name": "[format(\'{0}-DataDisk\', parameters(\'dnsLabelPrefix\'))]", "caching": "None", "createOption": "Empty", "diskSizeGB": 1024, "lun": 0}]}, "networkProfile": {"networkInterfaces": [{"id": "[resourceId(\'Microsoft.Network/networkInterfaces\', variables(\'nicName\'))]"}]}, "diagnosticsProfile": {"bootDiagnostics": {"enabled": true, "storageUri": "[reference(resourceId(\'Microsoft.Storage/storageAccounts\', parameters(\'storageAccountName\'))).primaryEndpoints.blob]"}}}, "dependsOn": ["[resourceId(\'Microsoft.Network/networkInterfaces\', variables(\'nicName\'))]", "[resourceId(\'Microsoft.Storage/storageAccounts\', parameters(\'storageAccountName\'))]"]}, {"type": "Microsoft.Compute/virtualMachines/extensions", "apiVersion": "2021-03-01", "name": "[format(\'{0}/{1}\', parameters(\'dnsLabelPrefix\'), \'joindomain\')]", "location": "[parameters(\'location\')]", "properties": {"publisher": "Microsoft.Compute", "type": "JsonADDomainExtension", "typeHandlerVersion": "1.3", "autoUpgradeMinorVersion": true, "settings": {"name": "[parameters(\'domainToJoin\')]", "ouPath": "[parameters(\'ouPath\')]", "user": "[format(\'{0}\\\\{1}\', parameters(\'domainToJoin\'), parameters(\'domainUsername\'))]", "restart": true, "options": "[parameters(\'domainJoinOptions\')]"}, "protectedSettings": {"Password": "[parameters(\'domainPassword\')]"}}, "dependsOn": ["[resourceId(\'Microsoft.Compute/virtualMachines\', parameters(\'dnsLabelPrefix\'))]"]}]}


cli_script
Based on the provided ARM template and parameters, here\'s the equivalent Azure CLI script:\n\n```bash\n#!/bin/bash\n\n# Parameters\nvmSize="Standard_A2_v2"\nexistingVnetName="zytest"\npublicIPAddressName="$(dnsLabelPrefix)-pip" # Assuming dnsLabelPrefix is provided\nexistingSubnetName="zytest"\ndnsLabelPrefix="zytest"\ndomainToJoin="zytest"\ndomainUsername="zytest"\ndomainPassword="zytest"\nouPath=""\ndomainJoinOptions=3\nadminUsername="zytest"\nadminPassword="zytest"\nstorageAccountName="zytest"\nlocation="westus"\n\n# Variables\nimagePublisher="MicrosoftWindowsServer"\nimageOffer="WindowsServer"\nwindowsOSVersion="2019-Datacenter"\nnicName="${dnsLabelPrefix}-nic"\n\n# Create public IP address\naz network public-ip create \\\n    --name $publicIPAddressName \\\n    --location $location \\\n    --allocation-method Dynamic \\\n    --dns-name $dnsLabelPrefix\n\n# Create storage account\naz storage account create \\\n    --name $storageAccountName \\\n    --location $location \\\n    --kind StorageV2 \\\n    --sku Standard_LRS\n\n# Create network interface\npublicIpAddressId=$(az network public-ip show --name $publicIPAddressName --query "id" -o tsv)\nsubnetId=$(az network vnet subnet show --name $existingSubnetName --vnet-name $existingVnetName --query "id" -o tsv)\n\naz network nic create \\\n    --name $nicName \\\n    --location $location \\\n    --ip-configurations name=ipconfig1 private-ip-address-allocation=Dynamic public-ip-address=$publicIpAddressId subnet=$subnetId\n\n# Create virtual machine\nstorageUri=$(az storage account show --name $storageAccountName --query "primaryEndpoints.blob" -o tsv)\n\naz vm create \\\n    --name $dnsLabelPrefix \\\n    --location $location \\\n    --size $vmSize \\\n    --image $imagePublisher:$imageOffer:$windowsOSVersion:latest \\\n    --admin-username $adminUsername \\\n    --admin-password $adminPassword \\\n    --nics $nicName \\\n    --os-disk-name "${dnsLabelPrefix}-OsDisk" \\\n    --data-disk-sizes-gb 1024 \\\n    --diagnostics-storage-account $storageAccountName \\\n    --storage-caching ReadWrite\n\n# Create VM extension for domain join\naz vm extension set \\\n    --vm-name $dnsLabelPrefix \\\n    --name "joindomain" \\\n    --publisher "Microsoft.Compute" \\\n    --version "1.3" \\\n    --settings "{\\"name\\":\\"$domainToJoin\\", \\"ouPath\\":\\"$ouPath\\", \\"user\\":\\"$domainToJoin\\\\$domainUsername\\", \\"restart\\":true, \\"options\\":$domainJoinOptions}" \\\n    --protected-settings "{\\"Password\\":\\"$domainPassword\\"}"\n```\n\nPlease replace the placeholder `$(dnsLabelPrefix)` with the actual value of `dnsLabelPrefix` if it is provided elsewhere or needs to be dynamically determined. The above script assumes that the `dnsLabelPrefix` is set to "zytest" as per the default value in the ARM template.\n\nThis script is executable in a bash environment and will create the resources as defined in the ARM template using the Azure CLI. Make sure to log in to Azure (`az login`) and set the correct subscription (`az account set --subscription <subscription_id>`) before running the script.


verify_result
